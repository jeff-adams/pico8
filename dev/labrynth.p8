pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--labrynth
--by atomicxistence

function _init()
	cls()
	setup_vars()
	--labrynth setup
	free_tile={sprite=16,x=3,y=1}
	lab=setup_lab()
	--player setup
	players=player_setup()
	cplayer=players[1]
end

function _update()
	update()
end

function _draw()
	cls()
	draw_borders()
	--draw labrynth
	for row in all(lab) do
		foreach(row,draw_tile)
	end
	draw_tile(free_tile)
	--draw players
	foreach(players,draw_tile)

	--debug
	print(free_tile.x..","..free_tile.y,60,80,9)
	--spr(lab[cplayer.x][cplayer.y].sprite,80,80)
end	

function draw_borders()
	color(5)
	rect(origin,origin,origin+90,origin+90)
end

function draw_lab()
	for _row=1,9 do
		for _col=1,9 do
			local _tile=lab[_row][_col]
			spr(_tile,origin+8*_row,origin+8*_col)
		end
	end
end

function draw_tile(_tile)
	local _x,_y=_tile.x*8+origin,_tile.y*8+origin
	spr(_tile.sprite,_x,_y)
end

function tile_placement()
	if btnp(âŽ) then 
		--rotate tile
		free_tile.sprite=rotate_tile(free_tile.sprite)
		sfx(0)
	end
	if btnp(ðŸ…¾ï¸) then
		--push tile in
		push_tiles()
		update=player_movement
		sfx(2)
	end
	if btnp(â¬…ï¸) then 
		free_tile=move_freetile(free_tile,left) 
		sfx(1)
	end
	if btnp(âž¡ï¸) then 
		free_tile=move_freetile(free_tile,right)
		sfx(1) 
	end
	if btnp(â¬†ï¸) then 
		free_tile=move_freetile(free_tile,up) 
		sfx(1)
	end
	if btnp(â¬‡ï¸) then 
		free_tile=move_freetile(free_tile,down) 
		sfx(1)
	end
end

function player_movement()
	if btnp(ðŸ…¾ï¸) then
		cplayer=next_player(players,cplayer) 
		update=tile_placement
		sfx(3)
	end
	if btnp(â¬…ï¸) then 
		cplayer=move_direction(cplayer,left)
		sfx(1)
	end
	if btnp(âž¡ï¸) then 
		cplayer=move_direction(cplayer,right)
		sfx(1) 
	end
	if btnp(â¬†ï¸) then 
		cplayer=move_direction(cplayer,up)
		sfx(1)
	end
	if btnp(â¬‡ï¸) then 
		cplayer=move_direction(cplayer,down)
		sfx(1)
	end
end
-->8
--setup

function setup_vars()
	origin=0
	up={x=0,y=-1}
	down={x=0,y=1}
	right={x=1,y=0}
	left={x=-1,y=0}
	invalid_space={x=0,y=0}
	
	update=tile_placement
end

function setup_lab()
	local _lab=initial_lab()
	local _tiles={}
	--add 13 straight tiles (spr 33-36)
	_tiles=add_tiles(33,13,_tiles)
	--add 9 corner tiles (spr 17-20)
	_tiles=add_tiles(17,9,_tiles)
	--add 12 t tiles (spr 49-52)
	_tiles=add_tiles(49,12,_tiles)
	_tiles=shuffle_tiles(_tiles)
	--place the shuffled tiles and
	--get back the extra tile
	_lab,free_tile.sprite=place_tiles(_lab,_tiles)
	return _lab
end

--returns a 2d array of tiles
--tiles are an array of sprite, x & y
function initial_lab()
	local _lab={}
	local _index=1	
	for _x=1,9 do
		local _row={}
		for _y=1,9 do
			local _i=place_indicator(_x,_y)
			if _i==nil then 
				_i=place_default_tile(_x,_y,_index) 
				if _i==nil then
					_i=16
				else 
					_index+=1
				end	
			end
			local _tile={sprite=_i,x=_x,y=_y}	
			add(_row,_tile)
		end
		add(_lab,_row)
	end
	return _lab
end

function place_indicator(_x,_y)
	--down
	if _y==1 and mid(2,_x,8)%2==1 then return 1 end
	--left
	if _x==9 and mid(2,_y,8)%2==1 then return 2 end
	--up
	if _y==9 and mid(2,_x,8)%2==1 then return 3 end
	--right
	if _x==1 and mid(2,_y,8)%2==1 then return 4 end
	--not an indicator
	return nil
end

function place_default_tile(_x,_y,_index)
	--default tile sequence
	local _tiles={17,49,49,20,50,49,52,52,50,50,51,52,18,51,51,19}
	--inside spaces
	if is_inside_space(_x,_y) then 
		 if _x%2==0 and _y%2==0 then
		 	return _tiles[_index]
		 end
	end
	return nil
end

function add_tiles(_spr,_count,_tiles)
	for i=1,_count do
		add(_tiles,flr(rnd(4)+_spr))
	end
	return _tiles
end

function shuffle_tiles(_tiles)
	for i=#_tiles, 2, -1 do
  		local j=max(flr(rnd(i)),1)
  		_tiles[i],_tiles[j]=_tiles[j],_tiles[i]
 	end
	return _tiles
end

function place_tiles(_lab,_tiles)
	--place tiles on empty spots
	local _tindex=1
	for i=1,#_lab do
		for j=1,#_lab[i] do
			if is_inside_space(i,j) then
				local _tile=_lab[i][j]
				if _tile.sprite==16 then
					_lab[i][j]={sprite=_tiles[_tindex],x=i,y=j}
					_tindex+=1
				end
			end
		end
	end
	return _lab,_tiles[_tindex]
end

function player_setup()
	local _players={}
	local _p1={sprite=5,x=2,y=2}
	add(_players,_p1)
	local _p2={sprite=6,x=8,y=8}
	add(_players,_p2)
	return _players
end
-->8
--logic

function is_inside_space(_x,_y)
	return _x==mid(2,_x,8) and _y==mid(2,_y,8)
end

function rotate_tile(_sprite)
	if _sprite%4==0 then
		_sprite-=3
	else	
		_sprite+=1
	end
	return _sprite
end

function move_freetile(_spr,_dir)
	local _destx,_desty=_dir.x*2,_dir.y*2
	if(abs(_dir.x)>0) then
		_spr.x,_spr.y=tile_limit(_spr.x,_spr.y,_destx)
		if same_space(_spr,invalid_space) then
			--only works for top/right, bottom/left corners
			_spr.y,_spr.x=tile_limit(_spr.y,_spr.x,_destx)
		end
	end
	if(abs(_dir.y)>0) then
		_spr.y,_spr.x=tile_limit(_spr.y,_spr.x,_desty)
		if same_space(_spr,invalid_space) then
			_spr.x,_spr.y=tile_limit(_spr.x,_spr.y,_desty)
		end
	end
	if same_space(_spr,invalid_space) then
		return move_freetile(_spr,_dir)
	end
	return _spr
end

function tile_limit(_a,_b,_dest)
	if _b==1 or _b==9 then
		_a=mid(1,_a+_dest,9)
		if _a==1 or _a==9 then
			_b=_b==1 and 3 or 7
		end
	end
	return _a,_b
end

function next_player(_players,_cplayer)
	--returns next in table, circular
	local _key=nil
	for k,v in pairs(_players) do
  		if v==_cplayer then _key=k end
 	end
	local _,_nplayer=next(_players,_key)
	--_nplayer will be nil if its the last in the table
	return _nplayer and _nplayer or _players[1]
end

function push_tiles()
	--get location of free_tile
	local _x,_y,_temp=free_tile.x,free_tile.y,free_tile
	if _x==1 or _x ==9 then --free tile is on the left or right
		local _row={}
		for i=1,9 do
			add(_row,lab[i][_y])
		end
		if _x==1 then --push right
			for i=2,#_row-1 do
				_row[i],_temp=_temp,_row[i]
				_row[i]=move_direction(_row[i],right)
			end
			invalid_space={x=9,y=_y}
		else  --push left
			for i=#_row-1,2,-1 do
				_row[i],_temp=_temp,_row[i]
				_row[i]=move_direction(_row[i],left)
			end
			invalid_space={x=1,y=_y}
		end
		--change labrynth row
		for i=1,9 do
			lab[i][_y]=_row[i]
		end
	else --free tile is on top or bottom
		local _column=lab[_x]
		--push down
		if _y==1 then --push down
			for i=2,#_column-1 do
				_column[i],_temp=_temp,_column[i]
				_column[i]=move_direction(_column[i],down)
			end
			invalid_space={x=_x,y=9}
		else --push up
			for i=#_column-1,2,-1 do
				_column[i],_temp=_temp,_column[i]
				_column[i]=move_direction(_column[i],up)
			end
			invalid_space={x=_x,y=1}
		end
		--change labrynth column
		lab[_x]=_column
	end
	--reassign free_tile
	free_tile={sprite=_temp.sprite,x=invalid_space.x,y=invalid_space.y}
end

function move_direction(_obj,_dir)
	_obj.x+=_dir.x
	_obj.y+=_dir.y
	return _obj
end

function same_space(_a,_b)
	return _a.x==_b.x and _a.y==_b.y
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000a0000000a00000000a00000080000000c0000000b0000000e000000000000000000000000000000000000000000000000000000000000
007007000000000000aa000000aaa0000000aa000088800000ccc00000bbb00000eee00000000000000000000000000000000000000000000000000000000000
00077000000000000aaa00000aaaaa000000aaa000080000000c0000000b0000000e000000000000000000000000000000000000000000000000000000000000
000770000aaaaa0000aa0000000000000000aa000080800000c0c00000b0b00000e0e00000000000000000000000000000000000000000000000000000000000
0070070000aaa000000a0000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000055666660666665506666655055666660000088000000cc000000bb000000ee0000000000000000000000000000000000000000000000000000000000
0000000055666660666665506666655055666660088808000ccc0c000bbb0b000eee0e0000000000000000000000000000000000000000000000000000000000
00000000556666606666655066666550556666600080880000c0cc0000b0bb0000e0ee0000000000000000000000000000000000000000000000000000000000
00000000556665505566655055555550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505566655055555550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666605566655066666660556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666605566655066666660556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666605566655066666660556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556666606666666066666550666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556666606666666066666550666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556666606666666066666550666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505566655055666550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505566655055666550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000110032003200120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000310031003200330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000310034003300330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000140034003400130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000300030003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000600001762017620206200060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600
000600000d1400d140071400714000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100
000600001f1501f15019150191501f1501f1501c1501c150151501515015150151501015010150101501015000100001000010000100001000010000100001000010000100001000010000100001000010000100
000400000645004450014500040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400
