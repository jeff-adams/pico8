pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--labrynth
--by atomicxistence

--todo
--item spawn
--item pickup
--gui display of inventory
--check invalid space before push_tile
--players/items pushed off the edge respawn on opposite side

function _init()
	cls()
	setup_vars()
	--labrynth setup
	local _starting_pos=positions[1]
	free_tile={sprite=16,x=_starting_pos.x,y=_starting_pos.y,pos_key=1}
	lab=setup_lab()
	--player setup
	players=player_setup()
	cplayer=players[1]

	debug={}
end

function _update()
	if task_running() then
		--continue running
	else
		update()
	end
end

function _draw()
	cls()
	draw_borders()
	--draw labrynth
	for row in all(lab) do
		foreach(row,draw_tile)
	end
	draw_tile(free_tile)
	--draw players
	foreach(players,draw_tile)
	--draw text
	draw_instructions()
end	

function draw_borders()
	color(5)
	rect(origin,origin,origin+90,origin+90)
end

function draw_lab()
	for _row=1,9 do
		for _col=1,9 do
			local _tile=lab[_row][_col]
			spr(_tile,origin+8*_row,origin+8*_col)
		end
	end
end

function draw_tile(_tile)
	local _x,_y=flr(_tile.x*8+origin),flr(_tile.y*8+origin)
	spr(_tile.sprite,_x,_y)
end

function draw_instructions()
	cursor(origin+4,origin+94)
	color(9)
	print("player "..(cplayer.sprite-4).."'s turn")
	print("------------------")
	foreach(instructions, print)
	color()
end

function task_running()
	for _task in all(task_pool) do
		if costatus(_task)=="suspended" then
			assert(coresume(_task))
		else
			del(task_pool,_task)
		end
	end
	return #task_pool>0
end

function update_tile()
	instructions[1]="❎: rotate tile"
	instructions[2]="🅾️: shift labrynth"
	if btnp(❎) then 
		--rotate tile
		free_tile.sprite=rotate_tile(free_tile.sprite)
		sfx(0)
	end
	if btnp(🅾️) then
		--push tile in
		push_tiles()
		update=update_player
		sfx(2)
	end
	if btnp(⬅️) then 
		free_tile=move_freetile(free_tile,left) 
		sfx(1)
	end
	if btnp(➡️) then 
		free_tile=move_freetile(free_tile,right)
		sfx(1) 
	end
	if btnp(⬆️) then 
		free_tile=move_freetile(free_tile,up) 
		sfx(1)
	end
	if btnp(⬇️) then 
		free_tile=move_freetile(free_tile,down) 
		sfx(1)
	end
end

function update_player()
	instructions[1]="❎: end turn"
	instructions[2]=nil
	local _ctile=lab[cplayer.x][cplayer.y]
	debug=_ctile
	if btnp(❎) then
		cplayer=next_circular(players,get_key(players,cplayer)) 
		update=update_tile
		sfx(3)
	end
	if btnp(⬅️) then
		move_player(_ctile,left)
	end
	if btnp(➡️) then 
		move_player(_ctile,right)
	end
	if btnp(⬆️) then 
		move_player(_ctile,up)
	end
	if btnp(⬇️) then 
		move_player(_ctile,down)
	end
end

function move_player(_tile,_dir)
	if is_path(_tile,_dir) then 
		move_direction(cplayer,_dir)
		sfx(1)
	else
		sfx(4)
	end
end
-->8
--setup

function setup_vars()
	origin=2
	up={x=0,y=-1,flag=2}
	down={x=0,y=1,flag=3}
	right={x=1,y=0,flag=1}
	left={x=-1,y=0,flag=0}
	positions={{x=3,y=1},{x=5,y=1},{x=7,y=1},{x=9,y=3},{x=9,y=5},{x=9,y=7},{x=7,y=9},{x=5,y=9},{x=3,y=9},{x=1,y=7},{x=1,y=5},{x=1,y=3}}
	invalid_space={x=0,y=0}
	
	ani_speed=8
	update=update_tile
	task_pool={}
	instructions={}
end

function setup_lab()
	local _lab=initial_lab()
	local _tiles={}
	--add 13 straight tiles (spr 33-36)
	_tiles=add_tiles(33,13,_tiles)
	--add 9 corner tiles (spr 17-20)
	_tiles=add_tiles(17,9,_tiles)
	--add 12 t tiles (spr 49-52)
	_tiles=add_tiles(49,12,_tiles)
	_tiles=shuffle_tiles(_tiles)
	--place the shuffled tiles and
	--get back the extra tile
	_lab,free_tile.sprite=place_tiles(_lab,_tiles)
	return _lab
end

function initial_lab()
	--returns a 2d array of tiles
	--tiles are an array of sprite, x & y
	local _lab={}
	local _index=1	
	for _x=1,9 do
		local _row={}
		for _y=1,9 do
			local _i=place_indicator(_x,_y)
			if _i==nil then 
				_i=place_default_tile(_x,_y,_index) 
				if _i==nil then
					_i=16
				else 
					_index+=1
				end	
			end
			local _tile={sprite=_i,x=_x,y=_y}	
			add(_row,_tile)
		end
		add(_lab,_row)
	end
	return _lab
end

function place_indicator(_x,_y)
	--down
	if _y==1 and mid(2,_x,8)%2==1 then return 1 end
	--left
	if _x==9 and mid(2,_y,8)%2==1 then return 2 end
	--up
	if _y==9 and mid(2,_x,8)%2==1 then return 3 end
	--right
	if _x==1 and mid(2,_y,8)%2==1 then return 4 end
	--not an indicator
	return nil
end

function place_default_tile(_x,_y,_index)
	--default tile sequence
	local _tiles={17,49,49,20,50,49,52,52,50,50,51,52,18,51,51,19}
	--inside spaces
	if is_inside_space(_x,_y) then 
		 if _x%2==0 and _y%2==0 then
		 	return _tiles[_index]
		 end
	end
	return nil
end

function add_tiles(_spr,_count,_tiles)
	for i=1,_count do
		add(_tiles,flr(rnd(4)+_spr))
	end
	return _tiles
end

function shuffle_tiles(_tiles)
	for i=#_tiles, 2, -1 do
  		local j=max(flr(rnd(i)),1)
  		_tiles[i],_tiles[j]=_tiles[j],_tiles[i]
 	end
	return _tiles
end

function place_tiles(_lab,_tiles)
	--place tiles on empty spots
	local _tindex=1
	for i=1,#_lab do
		for j=1,#_lab[i] do
			if is_inside_space(i,j) then
				local _tile=_lab[i][j]
				if _tile.sprite==16 then
					_lab[i][j]={sprite=_tiles[_tindex],x=i,y=j}
					_tindex+=1
				end
			end
		end
	end
	return _lab,_tiles[_tindex]
end

function player_setup()
	local _players={}
	local _p1={sprite=5,x=2,y=2}
	add(_players,_p1)
	local _p2={sprite=6,x=8,y=8}
	add(_players,_p2)
	return _players
end
-->8
--logic

function is_inside_space(_x,_y)
	return _x==mid(2,_x,8) and _y==mid(2,_y,8)
end

function rotate_tile(_sprite)
	if _sprite%4==0 then
		_sprite-=3
	else	
		_sprite+=1
	end
	return _sprite
end

function move_freetile(_spr,_dir)
	if _dir.x==-1 or _dir.y==-1 then
		_v2,_spr.pos_key=previous_circular(positions,_spr.pos_key)
	else
		_v2,_spr.pos_key=next_circular(positions,_spr.pos_key)
	end
	_spr.x,_spr.y=_v2.x,_v2.y
	--skips the invalid space
	if same_space(_spr,invalid_space) then return move_freetile(_spr,_dir) end
	return _spr
end

function tile_limit(_a,_b,_dest)
	if _b==1 or _b==9 then
		_a=mid(1,_a+_dest,9)
		if _a==1 or _a==9 then
			_b=_b==1 and 3 or 7
		end
	end
	return _a,_b
end

function next_circular(_list,_key)
	--returns next in table, circular
	_key=_key%#_list+1
	return _list[_key],_key
end

function previous_circular(_list,_key)
	--returns previous in table, circular
	_key=(_key-2)%#_list+1
	return _list[_key],_key
end

function get_key(_table,_value)
	--shallow search for table contents
	for k,v in pairs(_table) do
		if v==_value then return k end
	end
	--deep search for value comparison
	for k,v in pairs(_table) do
		if v.x==_value.x and v.y==_value.y then return k end
	end
	return nil
end

function push_tiles()
	--get location of free_tile
	local _x,_y,_temp=free_tile.x,free_tile.y,free_tile
	if _x==1 or _x ==9 then --free tile is on the left or right
		local _row={}
		for i=1,9 do
			add(_row,lab[i][_y])
		end
		if _x==1 then --push right
			for i=2,#_row-1 do
				--swap tiles
				_row[i],_temp=_temp,_row[i]
				--change the tile's x,y v2s
				move_direction(_row[i],right)
			end
			for _player in all(players) do
				if _player.y==_y then move_direction(_player,right) end
			end
			invalid_space={x=9,y=_y}
		else  --push left
			for i=#_row-1,2,-1 do
				_row[i],_temp=_temp,_row[i]
				move_direction(_row[i],left)
			end
			for _player in all(players) do
				if _player.y==_y then move_direction(_player,left) end
			end
			invalid_space={x=1,y=_y}
		end
		--change labrynth row
		for i=1,9 do
			lab[i][_y]=_row[i]
		end
	else --free tile is on top or bottom
		local _column=lab[_x]
		--push down
		if _y==1 then --push down
			for i=2,#_column-1 do
				_column[i],_temp=_temp,_column[i]
				move_direction(_column[i],down)
			end
			for _player in all(players) do
				if _player.x==_x then move_direction(_player,down) end
			end
			invalid_space={x=_x,y=9}
		else --push up
			for i=#_column-1,2,-1 do
				_column[i],_temp=_temp,_column[i]
				move_direction(_column[i],up)
			end
			for _player in all(players) do
				if _player.x==_x then move_direction(_player,up) end
			end
			invalid_space={x=_x,y=1}
		end
		--change labrynth column
		lab[_x]=_column
	end
	--reassign free_tile
	free_tile={
		sprite=_temp.sprite,
		x=invalid_space.x,
		y=invalid_space.y,
		pos_key=get_key(positions,invalid_space)}
end

function move_direction(_obj,_dir)
	local _task=cocreate(function() move_animate(_obj,_dir) end)
	add(task_pool,_task)
end

function move_animate(_obj,_dir)
	local _offset=1/ani_speed
	for i=1,ani_speed do
		_obj.x+=_offset*_dir.x
		_obj.y+=_offset*_dir.y
		yield()
	end
end

function same_space(_a,_b)
	return _a.x==_b.x and _a.y==_b.y
end

function is_path(_tile,_dir)
	if fget(_tile.sprite,_dir.flag) then
		--get tile in desired direction
		local _dtile,_dflag=lab[_tile.x+_dir.x][_tile.y+_dir.y],_dir.flag%2==0 and _dir.flag+1 or _dir.flag-1
		if is_inside_space(_dtile.x,_dtile.y) then
			return fget(_dtile.sprite,_dflag)		
		end
	end
	return false
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000a0000000a00000000a00000080000000c0000000b0000000e000000000000000000000000000000000000000000000000000000000000
007007000000000000aa000000aaa0000000aa000088800000ccc00000bbb00000eee00000000000000000000000000000000000000000000000000000000000
00077000000000000aaa00000aaaaa000000aaa000080000000c0000000b0000000e000000000000000000000000000000000000000000000000000000000000
000770000aaaaa0000aa0000000000000000aa000080800000c0c00000b0b00000e0e00000000000000000000000000000000000000000000000000000000000
0070070000aaa000000a0000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000055666660666665506666655055666660000088000000cc000000bb000000ee0000000000000000000000000000000000000000000000000000000000
0000000055666660666665506666655055666660088808000ccc0c000bbb0b000eee0e0000000000000000000000000000000000000000000000000000000000
00000000556666606666655066666550556666600080880000c0cc0000b0bb0000e0ee0000000000000000000000000000000000000000000000000000000000
00000000556665505566655055555550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505566655055555550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666605566655066666660556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666605566655066666660556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666605566655066666660556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555505566655055555550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505555555055666550556665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556666606666666066666550666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556666606666666066666550666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556666606666666066666550666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505566655055666550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000556665505566655055666550555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
00000000000000000000000000000000000a090506000000000000000000000000030c030c0000000000000000000000000e0b0d07000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000110032003200120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000310031003200330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000310034003300330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000140034003400130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000300030003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000600001762017620206200060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600
0006000004140041400c1400c14000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100
000600001f1501f15019150191501f1501f1501c1501c150151501515015150151501015010150101501015000100001000010000100001000010000100001000010000100001000010000100001000010000100
000400000645004450014500040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400004000040000400
000600000515005150001500015000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100
